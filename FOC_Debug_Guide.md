# 有感FOC电机不转问题排查指南

## 可能的原因和解决方案

### 1. UART通信问题
**检查项目：**
- ESP32是否正常发送数据
- 波特率是否匹配（115200）
- 硬件连接是否正确

**调试方法：**
```c
// 在main.c主循环中检查UART数据接收
if(ms_1000 >= 2500){
    ms_1000 = 0;
    Led1_Toggle;
    // 检查g_uart_data_count是否在增加
    // 如果计数器不增加，说明UART没有接收到数据
}
```

**解决方案：**
- 确认ESP32正常工作并发送数据
- 检查GPIO28(SCIA RX)和GPIO29(SCIA TX)连接
- 用示波器检查UART信号

### 2. 电角度数据问题
**检查项目：**
- 电角度是否在0-360度范围内
- AS5600编码器是否正常工作
- 磁铁是否正确安装

**当前代码修改：**
- 增加了电角度范围检查（0~2π弧度）
- 增加了数据计数器验证

### 3. FOC控制参数问题
**已修改的参数：**
```c
float target_iq = 0.3f;  // 从0.15A增加到0.3A，提供更大转矩
```

**检查项目：**
- PID参数是否合适
- 目标电流是否足够大
- 电压限幅是否合理

### 4. 控制逻辑问题
**已修改的逻辑：**
```c
// 确保接收到足够多的数据才切换到有感控制
if(g_has_valid_angle && g_uart_data_count > 10) {
    // 有感FOC控制
    Sensor_FOC_Control(g_electric_angle_rad, 0.0f, target_iq);
}
else {
    // 开环控制（用于对比测试）
    IF_OpenLoop_Control(500, 5, target_iq);
}
```

### 5. 硬件问题
**检查项目：**
- 电源电压是否足够
- 电机相线连接是否正确
- 功率器件是否正常
- 电流采样是否正常

### 6. ADC采样问题
**检查项目：**
- ADC是否正常采样电流
- 电流传感器是否工作正常
- 采样电阻是否合适

## 调试步骤

### 步骤1：验证开环控制
```c
// 先注释掉有感FOC，只使用开环控制
IF_OpenLoop_Control(500, 5, 0.3f);
```
如果开环控制电机能转，说明硬件没问题。

### 步骤2：验证UART通信
```c
// 检查g_uart_data_count是否在增加
// 检查g_electric_angle_rad是否有变化
```

### 步骤3：验证电角度数据
```c
// 手动设置固定电角度测试
float test_angle = 1.57f;  // 90度
Sensor_FOC_Control(test_angle, 0.0f, 0.3f);
```

### 步骤4：逐步增加目标电流
```c
float target_iq = 0.1f;  // 从小电流开始
// 逐步增加到0.2f, 0.3f, 0.5f...
```

### 步骤5：检查电流环响应
- 观察Id、Iq电流是否跟踪目标值
- 检查PID输出是否合理

## 推荐的调试配置

### 1. 安全启动配置
```c
float target_iq = 0.2f;  // 较小的起始电流
// 确保有足够数据才启动有感控制
if(g_uart_data_count > 20 && g_has_valid_angle)
```

### 2. 渐进式电流增加
```c
// 可以在运行过程中逐步增加目标电流
if(ms_1000 > 5000) target_iq = 0.3f;
if(ms_1000 > 10000) target_iq = 0.4f;
```

### 3. 故障检测
```c
// 检测异常情况
if(Curr_foc.Id > 2.0f || Curr_foc.Iq > 2.0f) {
    // 电流过大，切换到安全模式
    target_iq = 0.0f;
}
```

## 常见问题解决

1. **电机抖动**：PID参数需要调整，或者电角度噪声太大
2. **电机不转但有电流**：电角度可能不准确，检查编码器
3. **电机转向错误**：检查电机相线连接或电角度方向
4. **启动困难**：增加起始转矩或使用启动序列

## 下一步调试建议

1. 先确认开环控制正常工作
2. 验证UART数据正常接收
3. 手动设置固定角度测试有感控制
4. 逐步优化PID参数和目标电流
